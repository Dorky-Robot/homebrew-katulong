name: Build Bottles

on:
  push:
    branches:
      - master
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-bottle:
    strategy:
      matrix:
        os:
          - macos-15      # macOS Sequoia (ARM)
          - macos-14      # macOS Sonoma (ARM)
    runs-on: ${{ matrix.os }}
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Setup tap
        run: |
          # Create tap directory structure
          mkdir -p "$(brew --repository)/Library/Taps/dorky-robot"
          ln -s "$PWD" "$(brew --repository)/Library/Taps/dorky-robot/homebrew-katulong"

      - name: Build bottle
        run: |
          # Build bottle
          brew install --build-bottle dorky-robot/katulong/katulong
          brew bottle --json --no-rebuild dorky-robot/katulong/katulong

      - name: Upload bottle
        uses: actions/upload-artifact@v4
        with:
          name: bottles-${{ matrix.os }}
          path: '*.bottle.*'
          if-no-files-found: error

  upload-bottles:
    runs-on: ubuntu-latest
    needs: build-bottle
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    permissions:
      contents: write
    steps:
      - name: Checkout tap
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Download all bottles
        uses: actions/download-artifact@v4
        with:
          path: bottles

      - name: Merge and publish bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}
        run: |
          # Configure git before brew bottle merge (it commits automatically)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # List what was downloaded
          pwd
          ls -R bottles/ || echo "No bottles directory"

          # Flatten bottle directory structure (artifacts create subdirs)
          find bottles -name "*.bottle.tar.gz" -exec mv {} . \;
          find bottles -name "*.bottle.json" -exec mv {} . \;

          # List bottles in current directory
          ls -la *.bottle.* || echo "No bottles found"

          # Merge bottles into formula (formula path determined from JSON)
          # This will automatically commit the changes
          brew bottle --merge --write *.bottle.json

          # Push updated formula
          git push || echo "Nothing to push"

      - name: Upload bottles to GitHub Releases
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Get the latest tag from the main repo
          VERSION=$(grep -m1 'version' Formula/katulong.rb | cut -d'"' -f2)

          # Create release if it doesn't exist (ignore error if it does)
          gh release create "v${VERSION}" --title "v${VERSION}" --notes "Bottles for v${VERSION}" --repo "${{ github.repository }}" || true

          # Upload all bottle files
          find . -maxdepth 1 -name "*.bottle.tar.gz" -exec gh release upload "v${VERSION}" {} --repo "${{ github.repository }}" --clobber \;
